#!/bin/bash

# -------------------------------------------------------------------------------
# SSH user

# Get name from dish or shell args
NEWUSER=$1
[[ "$NEWUSER" && "$NEWUSER" != "--" ]] || NEWUSER=op

# Cloud host default key
KEY0=~/.ssh/authorized_keys

# Dish host  default key
KEY1=/home/app/op/.ssh/authorized_keys

HOMEDIR=/home/app/$NEWUSER

# Check if user exists already
grep -qe "^$NEWUSER:" /etc/passwd || useradd -d $HOMEDIR -m -r -s /bin/bash -Gwww-data -gusers $NEWUSER

[ -d $HOMEDIR/.ssh ] ||  sudo -u $NEWUSER mkdir -m 700 $HOMEDIR/.ssh

[ -f $HOMEDIR/.ssh/authorized_keys ] || {
  if [ -f $KEY0 ] ; then
    KEY=$KEY0
  elif [ -f $KEY1 ] ; then
    KEY=$KEY1
  else
    echo "WARNING: ssh key not found"
  fi
  [ "$KEY" ] && {
    echo "Using pub key $KEY"
    cat $KEY | head -1 > $HOMEDIR/.ssh/authorized_keys
    chown $NEWUSER $HOMEDIR/.ssh/authorized_keys
    chmod 600 $HOMEDIR/.ssh/authorized_keys
  }
}

[ -f /etc/sudoers.d/$NEWUSER ] || {
  cat > /etc/sudoers.d/$NEWUSER <<-EOF
	$NEWUSER ALL=NOPASSWD:/usr/bin/supervisorctl
	$NEWUSER ALL=NOPASSWD:/usr/sbin/nginx
	$NEWUSER ALL=NOPASSWD:/usr/bin/docker
	$NEWUSER ALL=NOPASSWD:/usr/bin/mc
	$NEWUSER ALL=($NEWUSER) NOPASSWD:ALL
	EOF
  chmod 440 /etc/sudoers.d/$NEWUSER
}


cat <<EOF
User $NEWUSER setup complete
You should ssh login via $NEWUSER now
EOF
